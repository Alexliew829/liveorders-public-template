<!-- 保持你现有 <head> 与样式不变，略过 -->

<script>
  async function call(api, isPost = false) {
    try {
      if (api.includes('exportOrders')) {
        const res = await fetch(api, { method: isPost ? 'POST' : 'GET' });
        const blob = await res.blob();
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = String(today.getFullYear()).toString().slice(2);
        const filename = `${day}-${month}-${year} Bonsai-Order.xlsx`;
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }

      const res = await fetch(api, {
        method: isPost ? 'POST' : 'GET',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await res.json();
      alert(data.message || JSON.stringify(data));
    } catch (err) {
      alert('❌ 错误：' + (err.message || '无法连接服务器'));
    }
  }

  async function showPendingOrders() {
    try {
      const res = await fetch('/api/pendingOrders');
      const data = await res.json();
      const box = document.getElementById('orderResults');
      if (!Array.isArray(data) || data.length === 0) {
        box.innerHTML = '暂无待发订单';
        return;
      }

      let html = '';
      const tngLink = 'https://payment.tngdigital.com.my/sc/dRacq2iFOb';

      for (const order of data) {
        const user = order.user_name || '匿名顾客';
        const items = order.items || [];
        let total = 0;

        html += `<strong>${user}</strong><br>`;

        for (const item of items) {
          const qty = item.quantity || 1;
          const price = parseFloat(item.price) || 0;
          const sub = qty * price;
          total += sub;
          html += `▪️ ${item.selling_id || ''} ${item.product_name || ''} x${qty} = RM${sub.toFixed(2)}<br>`;
        }

        html += `<br><strong>总金额：RM${total.toFixed(2)}</strong><br>`;

        // ✅ 付款说明块，便于复制
        html += `<pre>
总金额：RM${total.toFixed(2)}
Maybank：512389673060
Public Bank：3214928526
TNG 电子钱包付款链接：
${tngLink}
</pre>`;

        // ✅ 按钮：只显示一个，作为“发送付款连接”操作
        html += `<button class="action-button" onclick="sendPayment('${user}')">💳 发送付款连接</button><hr>`;
      }

      box.innerHTML = html;
    } catch (err) {
      alert('❌ 获取订单失败：' + err.message);
    }
  }

  function sendPayment(user) {
    alert(`⚠️ 你点击了发送付款连接给：${user}。\n\n请将该顾客最后一次留言的 comment_id 发送至后端 API /api/manualSend 手动补发付款连接。`);
    // 实际项目中，可通过传 comment_id 调用补发接口
  }
</script>
