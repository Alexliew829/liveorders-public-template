<!-- ä¿æŒä½ ç°æœ‰ <head> ä¸æ ·å¼ä¸å˜ï¼Œç•¥è¿‡ -->

<script>
  async function call(api, isPost = false) {
    try {
      if (api.includes('exportOrders')) {
        const res = await fetch(api, { method: isPost ? 'POST' : 'GET' });
        const blob = await res.blob();
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = String(today.getFullYear()).toString().slice(2);
        const filename = `${day}-${month}-${year} Bonsai-Order.xlsx`;
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }

      const res = await fetch(api, {
        method: isPost ? 'POST' : 'GET',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await res.json();
      alert(data.message || JSON.stringify(data));
    } catch (err) {
      alert('âŒ é”™è¯¯ï¼š' + (err.message || 'æ— æ³•è¿æ¥æœåŠ¡å™¨'));
    }
  }

  async function showPendingOrders() {
    try {
      const res = await fetch('/api/pendingOrders');
      const data = await res.json();
      const box = document.getElementById('orderResults');
      if (!Array.isArray(data) || data.length === 0) {
        box.innerHTML = 'æš‚æ— å¾…å‘è®¢å•';
        return;
      }

      let html = '';
      const tngLink = 'https://payment.tngdigital.com.my/sc/dRacq2iFOb';

      for (const order of data) {
        const user = order.user_name || 'åŒ¿åé¡¾å®¢';
        const items = order.items || [];
        let total = 0;

        html += `<strong>${user}</strong><br>`;

        for (const item of items) {
          const qty = item.quantity || 1;
          const price = parseFloat(item.price) || 0;
          const sub = qty * price;
          total += sub;
          html += `â–ªï¸ ${item.selling_id || ''} ${item.product_name || ''} x${qty} = RM${sub.toFixed(2)}<br>`;
        }

        html += `<br><strong>æ€»é‡‘é¢ï¼šRM${total.toFixed(2)}</strong><br>`;

        // âœ… ä»˜æ¬¾è¯´æ˜å—ï¼Œä¾¿äºå¤åˆ¶
        html += `<pre>
æ€»é‡‘é¢ï¼šRM${total.toFixed(2)}
Maybankï¼š512389673060
Public Bankï¼š3214928526
TNG ç”µå­é’±åŒ…ä»˜æ¬¾é“¾æ¥ï¼š
${tngLink}
</pre>`;

        // âœ… æŒ‰é’®ï¼šåªæ˜¾ç¤ºä¸€ä¸ªï¼Œä½œä¸ºâ€œå‘é€ä»˜æ¬¾è¿æ¥â€æ“ä½œ
        html += `<button class="action-button" onclick="sendPayment('${user}')">ğŸ’³ å‘é€ä»˜æ¬¾è¿æ¥</button><hr>`;
      }

      box.innerHTML = html;
    } catch (err) {
      alert('âŒ è·å–è®¢å•å¤±è´¥ï¼š' + err.message);
    }
  }

  function sendPayment(user) {
    alert(`âš ï¸ ä½ ç‚¹å‡»äº†å‘é€ä»˜æ¬¾è¿æ¥ç»™ï¼š${user}ã€‚\n\nè¯·å°†è¯¥é¡¾å®¢æœ€åä¸€æ¬¡ç•™è¨€çš„ comment_id å‘é€è‡³åç«¯ API /api/manualSend æ‰‹åŠ¨è¡¥å‘ä»˜æ¬¾è¿æ¥ã€‚`);
    // å®é™…é¡¹ç›®ä¸­ï¼Œå¯é€šè¿‡ä¼  comment_id è°ƒç”¨è¡¥å‘æ¥å£
  }
</script>
